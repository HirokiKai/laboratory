# Product Requirements Document: Gemini Slack Reply

## 1. 概要と目的
Slackスレッドへの返信下書きを、Google Gemini APIで即時生成し、Composerに直接挿入するChrome拡張。日本語専用で、トーン・呼称・関係性・経過時間を踏まえた安全で簡潔な返信を提供し、チームのコミュニケーション工数を削減する。

## 2. ターゲットユーザー
- Slack で日常的にスレッド返信を行う日本語話者。
- カスタマーサクセス/サポート、PdM/エンジニア、社内コミュニケーション担当など小〜中規模チーム。
- ユーザー自身が Gemini の API キーを保持できること。

## 3. 課題
- 長いスレッドを読み、宛先・依頼内容・緊急度を判断するのに時間がかかる。
- 敬称や関係性に応じたトーン調整が手間。
- 過去メッセージを踏まえた遅延謝罪など、時間経過に応じた文面調整が難しい。

## 4. ゴール / KPI
- 返信下書き作成時間を大幅短縮（目標: 1スレッドあたり<15秒で下書き挿入）。
- 生成失敗率（API/タイムアウト）<5%。
- 強制再生成率をモニタし、モデル/プロンプト改善につなげる。

## 5. スコープ
### 含む
- Slack Web 版 (app.slack.com) での返信生成・Composer への挿入。
- 日本語のみ出力、英語混入はエラー扱い。
- モデル選択、APIキー管理、呼称/関係性設定、追加指示、コスト見える化、キャッシュ再利用。

### 含まない / 将来検討
- Slack デスクトップアプリ対応、マルチワークスペース切替検知。
- 添付ファイル・画像の解析、送信ボタンの自動クリック。
- 英語/多言語出力、組織ポリシー共有設定。

## 6. 機能要件
### 6.1 設定・保存
- オプションページと Slack 内パネルから以下を保存: API キー、モデル選択（gemini-2.5-flash-lite / flash / 3-flash-preview）、自動生成 ON/OFF、追加指示、表示名、関係性(役割+呼び名)、敬称デフォルト、デバッグ ON/OFF。
- `chrome.storage.local` に永続化。

### 6.2 Slack UI 統合
- ヘッダー右側にトグルボタン（Sアイコン）を追加し、設定パネルを表示/非表示。
- 各スレッドの Composer 右ツールバーに「AI返信」ボタン＋▼メニュー（♻️強制再生成）。

### 6.3 返信生成ロジック
- スレッドメッセージを最大50件取得（親→古い→最新）。送信者名・本文・タイムスタンプを含むコンテキストを整形。
- 役割判断: 自分宛/第三者宛/全員宛を判定し、第三者の場合は依頼を引き受けない等の安全ガード。
- 時間考慮: 最新発話時刻と現在時刻から経過時間を算出し、遅延謝罪や緊急度調整を指示。
- チャンネル種別判定: DM/MPDM/Private/Public を channelId 先頭文字で推定し、トーンを調整。
- 呼称: 関係性設定の呼び名を優先し、なければデフォルト敬称（初期値「さん」）。メンションは付与しない。
- 日本語強制: 日本語が含まれない生成結果はエラーとして再試行促し。

### 6.4 キャッシュ・コスト
- 同一文脈（モデル+スレッド+コンテキスト）を5分キャッシュ。30秒以内は再利用を優先し、トーストで通知。
- モデル別に入出力文字数を累積し、単価テーブルから概算コストをパネルで表示。

### 6.5 エラーハンドリング/トースト
- APIキー未設定、Gemini エラー、25秒タイムアウト、拡張更新による context invalidation をトースト表示。

### 6.6 プライバシー/ログ
- 外部送信は Gemini API リクエストのみ。キー・使用量はローカル保存。デバッグON時のみコンソールログ。

## 7. UXフロー（主要シナリオ）
1) 初回設定: オプションページで API キー入力→モデル選択→自動生成 ON→保存。
2) 利用: スレッドを開き Composer の「AI返信」を押下→10〜20秒以内に下書き挿入→ユーザーが確認・送信。
3) 直近と同一文脈ならキャッシュ再挿入を通知。差し替えたい場合は▼から「強制再生成」。
4) エラー時はトースト表示し、ユーザーに再試行/キー確認を促す。

## 8. データモデル（chrome.storage.local）
- `geminiApiKey`, `gslrModel`, `gslrEnabled`, `gslrInstruction`, `gslrMyName`, `gslrRelationships`, `gslrHonorific`, `gslrDebug`。
- `modelStats`: モデル別の累積 input/output 文字数。
- 一時キャッシュ: コンテキストキー→ドラフト/タイムスタンプ、スレッドキー→ドラフト。

## 9. 技術アーキテクチャ
- Manifest V3。Background Service Worker: Gemini API 呼び出しとモデル別使用量集計、応答クレンジング。
- Content Script: Slack DOM 監視、ボタン/パネル注入、メッセージ収集、キャッシュ/トースト制御、チャンネル種別・経過時間推定。
- オプションページ: 設定入力・保存 UI。

## 10. 非機能要件
- レイテンシ: 25秒でタイムアウト、目標 15秒以内。
- 信頼性: DOM 変化に追従するミューテーション監視。セレクタ変更に備え月次確認を推奨。
- 言語安全: 日本語非含有の応答はエラー扱い。

## 11. リリース計画
- Alpha: 社内手動インストール（CRX）。主要ブラウザ最新版で動作確認。
- Beta: Chrome Web Store 限定公開。ユーザーフィードバックでプロンプト/モデルを調整。
- GA: 公開配布。簡易チュートリアルとオンボーディングを追加。

## 12. リスクと対策
- Slack DOM 変更でボタン挿入が失敗: セレクタ抽象化と定期検証。
- Gemini 無料枠超過/レート制限: 失敗メッセージとコスト表示で早期気付き。
- 宛先誤認: 表示名入力の促しと直近メンション優先判定を継続改善。
- プライバシー懸念: 「送信前の確認はユーザー責任」を明示（将来オンボーディングで補足）。

## 13. テスト観点
- APIキー未設定時のトースト表示。
- DM/MPDM/Private/Public でのメッセージ収集と生成。
- 日本語強制ガード（英語のみ応答でエラー）。
- キャッシュ再利用と強制再生成の分岐動作。
- 50件超スレッドの省略処理と正常生成。
- 経過時間・チャンネル種別に応じたトーン変化の確認（遅延謝罪や第三者返信）。
